substitutions:
  name: jk-bms
  device_description: "Monitor and control a JK-BMS v11 via bluetooth"
  external_components_source: github://rabbit3dcustom/esphome-jk-bms@main
  mac_address: C8:47:8C:E1:E2:AA
  esp_ip: 192.168.1.245
  # Please use "JK02_24S" if you own a old JK-BMS < hardware version 11.0 (hardware version >= 6.0 and < 11.0)
  # Please use "JK02_32S" if you own a new JK-BMS >= hardware version 11.0 (f.e. JK-B2A8S20P hw 11.XW, sw 11.26)
  # Please use "JK04" if you have some old JK-BMS <= hardware version 3.0 (f.e. JK-B2A16S hw 3.0, sw. 3.3.0)
  protocol_version: JK02_32S

esphome:
  name: ${name}
  comment: ${device_description}
  min_version: 2024.6.0
  project:
    name: "syssi.esphome-jk-bms"
    version: 2.0.0

esp32:
  board: esp32dev
  framework:
    type: esp-idf

external_components:
  - source: ${external_components_source}
    refresh: 0s

wifi:
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password

  # Optional manual IP
  manual_ip:
    static_ip: ${esp_ip}
    gateway: 192.168.1.1
    subnet: 255.255.255.0

ota:
  platform: esphome
  on_begin:
    then:
      - switch.turn_off: ble_client_switch0
      - logger.log: "BLE connection suspended for OTA update"

logger:
  level: DEBUG

# If you don't use Home Assistant please remove this `api` section and uncomment the `mqtt` component!
api:

web_server:
  port: 80

# mqtt:
#   broker: !secret mqtt_host
#   username: !secret mqtt_username
#   password: !secret mqtt_password
#   id: mqtt_client

esp32_ble_tracker:
  on_ble_advertise:
    then:
      - lambda: |-
          if (x.get_name().rfind("JK-", 0) == 0 || x.get_name().rfind("JK_", 0) == 0) {
            ESP_LOGI("ble_adv", "New JK-BMS found");
            ESP_LOGI("ble_adv", "  Name: %s", x.get_name().c_str());
            ESP_LOGI("ble_adv", "  MAC address: %s", x.address_str().c_str());
            ESP_LOGD("ble_adv", "  Advertised service UUIDs:");
            for (auto uuid : x.get_service_uuids()) {
              ESP_LOGD("ble_adv", "    - %s", uuid.to_string().c_str());
            }
          }

ble_client:
  - mac_address: ${mac_address}
    id: client0

jk_bms_ble:
  - ble_client_id: client0
    protocol_version: ${protocol_version}
    throttle: 5s
    id: bms0

binary_sensor:
  - platform: jk_bms_ble
    status_balancing:
      name: "${name} status balancing"
    status_charging:
      name: "${name} status charging"
    status_discharging:
      name: "${name} status discharging"
    status_heating:
      name: "${name} status heating"
    online_status:
      name: "${name} online status"

number:
  - platform: jk_bms_ble
    cell_request_charge_voltage_time:
      name: "${name} cell request charge volt time"
    cell_request_float_voltage_time:
      name: "${name} cell request float volt time"

# sensor:
#   - platform: jk_bms_ble
#     uart1_protocol_number:
#       name: "${name} uart1 protocol number"
#     uart2_protocol_number:
#       name: "${name} uart2 protocol number"

switch:
  - platform: ble_client
    ble_client_id: client0
    id: ble_client_switch0
    name: "${name} enable bluetooth connection"

text_sensor:
  - platform: jk_bms_ble
    errors:
      name: "${name} errors"
    operation_status:
      name: "${name} operation status"
    info_device_password:
      name: "${name} info_device_password"
    info_software_version:
      name: "${name} info_software_version"
    info_vendorid:
      name: "${name} info vendorid"
    info_hardware_version:
      name: "${name} info hardware version"
    info_device_name:
      name: "${name} info device name"
